<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ä½“ååŒåˆ†ææŠ¥å‘Š</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="top-nav">
        <div class="nav-container">
            <div class="nav-left">
                <span class="nav-icon">ğŸ”¬</span>
                <span class="nav-title">äººå·¥æ™ºèƒ½å®éªŒå®¤</span>
            </div>
            <div class="nav-right">
                <select id="sessionSelector" title="é€‰æ‹©åˆ†æä¼šè¯">
                    <option value="">é€‰æ‹©åˆ†æä¼šè¯...</option>
                </select>
                <button class="nav-btn" onclick="loadSessions()">åˆ·æ–°</button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- æŠ¥å‘Šæ ‡é¢˜åŒº -->
        <div class="title-section">
            <h1 class="main-title">æ™ºèƒ½ä½“ååŒåˆ†ææŠ¥å‘Š</h1>
            <p class="subtitle">äººå·¥æ™ºèƒ½å®éªŒå®¤æ™ºèƒ½åˆ†æAgentååŒåˆ†æ</p>
        </div>

        <!-- ä¸“å®¶æŠ•ç¥¨ç»“æœå¡ç‰‡ -->
        <div class="vote-card" id="voteCard">
            <div class="vote-header">
                <h3>ğŸ“Š ä¸“å®¶æŠ•ç¥¨ç»“æœ</h3>
            </div>
            <div class="vote-content">
                <div class="vote-stats">
                    <div class="bullish">
                        <span class="vote-number" id="bullCount">5</span>
                        <span class="vote-label">çœ‹æ¶¨ Bullish</span>
                    </div>
                    <div class="bearish">
                        <span class="vote-number" id="bearCount">1</span>
                        <span class="vote-label">çœ‹è·Œ Bearish</span>
                    </div>
                </div>
                <div class="vote-bar">
                    <div class="bar-bullish" id="bullBar">83.3%</div>
                    <div class="bar-bearish" id="bearBar">16.7%</div>
                </div>
            </div>
        </div>

        <!-- ä¸“å®¶åˆ†æè¯¦æƒ… -->
        <div class="analysis-section">
            <h2 class="section-title">ğŸ“‹ ä¸“å®¶åˆ†æè¯¦æƒ…</h2>
            <div class="analysis-grid" id="analysisGrid">
                <!-- åŠ¨æ€ç”Ÿæˆçš„åˆ†æå¡ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- ä¸“å®¶è¾©è®ºè¿‡ç¨‹ -->
        <div class="debate-section">
            <h2 class="section-title">ğŸ—£ï¸ ä¸“å®¶è¾©è®ºè¿‡ç¨‹</h2>
            <p class="section-subtitle">AIæ™ºèƒ½ä½“ååŒåˆ†æè¿‡ç¨‹å®æ—¶è®°å½•</p>
            <div class="timeline" id="timeline">
                <!-- åŠ¨æ€ç”Ÿæˆçš„æ—¶é—´è½´é¡¹ç›®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- å…è´£å£°æ˜ -->
        <div class="disclaimer">
            <h3>âš ï¸ å…è´£å£°æ˜</h3>
            <p>æœ¬æŠ¥å‘Šç”±äººå·¥æ™ºèƒ½ç³»ç»Ÿç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ã€‚</p>
        </div>
    </div>

    <script>
        // æ™ºèƒ½ä½“ä¿¡æ¯æ˜ å°„
        const agentMapping = {
            'company_overview_analyst': { name: 'å…¬å¸æ¦‚è¿°åˆ†æå¸ˆ', emoji: 'ğŸ¢' },
            'market_analyst': { name: 'å¸‚åœºåˆ†æå¸ˆ', emoji: 'ğŸ“ˆ' },
            'sentiment_analyst': { name: 'æƒ…ç»ªåˆ†æå¸ˆ', emoji: 'ğŸ˜Š' },
            'news_analyst': { name: 'æ–°é—»åˆ†æå¸ˆ', emoji: 'ğŸ“°' },
            'fundamentals_analyst': { name: 'åŸºæœ¬é¢åˆ†æå¸ˆ', emoji: 'ğŸ“‹' },
            'shareholder_analyst': { name: 'è‚¡ä¸œåˆ†æå¸ˆ', emoji: 'ğŸ‘¥' },
            'product_analyst': { name: 'äº§å“åˆ†æå¸ˆ', emoji: 'ğŸ­' },
            'bull_researcher': { name: 'çœ‹æ¶¨ç ”ç©¶å‘˜', emoji: 'ğŸ‚' },
            'bear_researcher': { name: 'çœ‹è·Œç ”ç©¶å‘˜', emoji: 'ğŸ»' },
            'research_manager': { name: 'ç ”ç©¶ç»ç†', emoji: 'ğŸ‘”' },
            'trader': { name: 'äº¤æ˜“å‘˜', emoji: 'ğŸ’¼' },
            'aggressive_risk_analyst': { name: 'æ¿€è¿›é£é™©åˆ†æå¸ˆ', emoji: 'âš¡' },
            'safe_risk_analyst': { name: 'ä¿å®ˆé£é™©åˆ†æå¸ˆ', emoji: 'ğŸ›¡ï¸' },
            'neutral_risk_analyst': { name: 'ä¸­æ€§é£é™©åˆ†æå¸ˆ', emoji: 'âš–ï¸' },
            'risk_manager': { name: 'é£é™©ç»ç†', emoji: 'ğŸ¯' }
        };

        // è·å–æ™ºèƒ½ä½“ä¿¡æ¯
        function getAgentInfo(agentName) {
            return agentMapping[agentName] || { name: agentName, emoji: 'ğŸ¤–' };
        }

        // åŠ è½½ä¼šè¯åˆ—è¡¨
        function loadSessions() {
            // ä»æœåŠ¡å™¨è·å–ä¼šè¯åˆ—è¡¨
            fetch('/api/sessions')
                .then(response => response.json())
                .then(sessions => {
                    const selector = document.getElementById('sessionSelector');
                    selector.innerHTML = '<option value="">é€‰æ‹©åˆ†æä¼šè¯...</option>';
                    
                    sessions.forEach(session => {
                        const option = document.createElement('option');
                        option.value = session.file;
                        option.textContent = session.name;
                        selector.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                    // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ–‡ä»¶åˆ—è¡¨ä½œä¸ºå¤‡é€‰
                    loadLocalSessions();
                });
        }
        
        // å¤‡é€‰ï¼šåŠ è½½æœ¬åœ°ä¼šè¯åˆ—è¡¨
        function loadLocalSessions() {
            const mockSessions = [
                { file: 'session_20250808_142740.json', name: '2025-08-08 14:27 - é™•è¥¿ç…¤ä¸šåˆ†æ' },
                { file: 'session_20250807_103022.json', name: '2025-08-07 10:30 - å¸‚åœºåˆ†æ' },
                { file: 'session_20250806_155510.json', name: '2025-08-06 15:55 - é£é™©è¯„ä¼°' }
            ];
            
            const selector = document.getElementById('sessionSelector');
            selector.innerHTML = '<option value="">é€‰æ‹©åˆ†æä¼šè¯...</option>';
            
            mockSessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.file;
                option.textContent = session.name;
                selector.appendChild(option);
            });
        }

        // ç»Ÿè®¡æŠ•ç¥¨ç»“æœ
        function calculateVoteStats(agents) {
            let bullish = 0;
            let bearish = 0;
            
            agents.forEach(agent => {
                const agentName = agent.agent_name.toLowerCase();
                const result = (agent.result || '').toLowerCase();
                
                // æ ¹æ®æ™ºèƒ½ä½“åç§°åˆ¤æ–­å€¾å‘
                if (agentName.includes('bull')) {
                    bullish++;
                } else if (agentName.includes('bear')) {
                    bearish++;
                } else if (agentName.includes('risk')) {
                    bearish++; // é£é™©åˆ†æå¸ˆå½’ç±»ä¸ºè°¨æ…/çœ‹è·Œ
                } else {
                    // æ ¹æ®ç»“æœå†…å®¹åˆ¤æ–­å€¾å‘
                    const bullishKeywords = ['çœ‹æ¶¨', 'ä¹°å…¥', 'æŒæœ‰', 'æ¨è', 'ç§¯æ', 'ä¹è§‚', 'å¢é•¿', 'ä¸Šæ¶¨', 'å»ºè®®ä¹°å…¥'];
                    const bearishKeywords = ['çœ‹è·Œ', 'å–å‡º', 'é£é™©', 'ä¸‹è·Œ', 'è°¨æ…', 'æ‚²è§‚', 'å‹åŠ›', 'ä¸ç¡®å®š', 'å»ºè®®å–å‡º'];
                    
                    const hasBullishSignal = bullishKeywords.some(keyword => result.includes(keyword));
                    const hasBearishSignal = bearishKeywords.some(keyword => result.includes(keyword));
                    
                    if (hasBullishSignal && !hasBearishSignal) {
                        bullish++;
                    } else if (hasBearishSignal && !hasBullishSignal) {
                        bearish++;
                    } else {
                        // é»˜è®¤åˆ†ç±»ï¼šåˆ†æå¸ˆç±»æ™ºèƒ½ä½“å€¾å‘ä¸­æ€§åå¤š
                        if (['company_overview_analyst', 'market_analyst', 'sentiment_analyst', 
                             'fundamentals_analyst', 'news_analyst', 'product_analyst', 
                             'shareholder_analyst'].includes(agentName)) {
                            bullish++;
                        } else {
                            bearish++;
                        }
                    }
                }
            });
            
            return { bullish, bearish };
        }

        // æ›´æ–°æŠ•ç¥¨ç»“æœ
        function updateVoteResults(agents) {
            const stats = calculateVoteStats(agents);
            const total = stats.bullish + stats.bearish;
            
            if (total === 0) return;
            
            const bullPercentage = (stats.bullish / total) * 100;
            const bearPercentage = (stats.bearish / total) * 100;
            
            document.getElementById('bullCount').textContent = stats.bullish;
            document.getElementById('bearCount').textContent = stats.bearish;
            
            const bullBar = document.getElementById('bullBar');
            const bearBar = document.getElementById('bearBar');
            
            bullBar.style.width = bullPercentage + '%';
            bullBar.textContent = bullPercentage.toFixed(1) + '%';
            bearBar.style.width = bearPercentage + '%';
            bearBar.textContent = bearPercentage.toFixed(1) + '%';
        }

        // ç”Ÿæˆåˆ†æè¯¦æƒ…å¡ç‰‡
        function generateAnalysisCards(agents) {
            const grid = document.getElementById('analysisGrid');
            grid.innerHTML = '';
            
            agents.forEach((agent, index) => {
                const agentInfo = getAgentInfo(agent.agent_name);
                let content = agent.result || 'æš‚æ— åˆ†æç»“æœ';
                
                // å¤„ç†Markdownæ ¼å¼çš„å†…å®¹ï¼Œæå–ä¸»è¦æ–‡æœ¬
                content = processMarkdownContent(content);
                
                // é™åˆ¶æ˜¾ç¤ºé•¿åº¦
                const shortContent = content.length > 200 ? content.substring(0, 200) + '...' : content;
                const needsExpand = content.length > 200;
                
                const card = document.createElement('div');
                card.className = 'analysis-card';
                card.style.animationDelay = (index * 0.1) + 's';
                
                // å®‰å…¨å¤„ç†å†…å®¹ï¼Œé¿å…XSS
                const safeContent = escapeHtml(content);
                const safeShortContent = escapeHtml(shortContent);
                
                card.innerHTML = `
                    <div class="card-header">
                        <span class="agent-name">${agentInfo.emoji} ${agentInfo.name}</span>
                    </div>
                    <div class="card-content">
                        <p>${safeShortContent}</p>
                        ${needsExpand ? `<button class="expand-btn" onclick="toggleExpand(this, ${JSON.stringify(safeContent)})">å±•å¼€</button>` : ''}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // å¤„ç†Markdownå†…å®¹ï¼Œæå–ä¸»è¦æ–‡æœ¬
        function processMarkdownContent(content) {
            if (!content) return '';
            
            // ç§»é™¤Markdownæ ‡è®°ï¼Œä¿ç•™ä¸»è¦æ–‡æœ¬
            return content
                .replace(/#{1,6}\s+/g, '') // ç§»é™¤æ ‡é¢˜æ ‡è®°
                .replace(/\*\*(.*?)\*\*/g, '$1') // ç§»é™¤ç²—ä½“æ ‡è®°
                .replace(/\*(.*?)\*/g, '$1') // ç§»é™¤æ–œä½“æ ‡è®°
                .replace(/`(.*?)`/g, '$1') // ç§»é™¤ä»£ç æ ‡è®°
                .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1') // ç§»é™¤é“¾æ¥æ ‡è®°ï¼Œä¿ç•™æ–‡æœ¬
                .replace(/^[-*+]\s+/gm, '') // ç§»é™¤åˆ—è¡¨æ ‡è®°
                .replace(/^\d+\.\s+/gm, '') // ç§»é™¤æ•°å­—åˆ—è¡¨æ ‡è®°
                .replace(/\n{2,}/g, '\n') // åˆå¹¶å¤šä¸ªæ¢è¡Œ
                .trim();
        }
        
        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç”Ÿæˆæ—¶é—´è½´ - ä¸¥æ ¼æŒ‰ç…§åŸè®¾è®¡
        function generateTimeline(agents) {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            
            agents.forEach((agent, index) => {
                const agentInfo = getAgentInfo(agent.agent_name);
                let content = agent.result || 'æš‚æ— åˆ†æç»“æœ';
                
                // å¤„ç†Markdownå†…å®¹
                content = processMarkdownContent(content);
                
                // ç¡®å®šå¡ç‰‡ä½ç½®ï¼ˆå·¦å³äº¤æ›¿ï¼‰
                const side = index % 2 === 0 ? 'left' : 'right';
                
                const item = document.createElement('div');
                item.className = `timeline-item ${side}`;
                item.style.animationDelay = (index * 0.1) + 's';
                
                // ä¿æŒå†…å®¹ç´§å‡‘
                const displayContent = content.length > 200 ? content.substring(0, 200) + '...' : content;
                
                // è·å–æ™ºèƒ½ä½“çš„æ—¶é—´æˆ³
                const timestamp = agent.end_time ? 
                    new Date(agent.end_time).toLocaleString('zh-CN') : 
                    new Date().toLocaleString('zh-CN');
                
                item.innerHTML = `
                    <div class="timeline-card">
                        <div class="card-header">
                            <span class="agent-name">${agentInfo.emoji} ${agentInfo.name}</span>
                        </div>
                        <div class="card-content">
                            <p>${escapeHtml(displayContent)}</p>
                            <div class="timestamp">${timestamp}</div>
                        </div>
                    </div>
                `;
                
                timeline.appendChild(item);
            });
        }

        // å±•å¼€/æ”¶èµ·è¯¦æƒ…
        function toggleExpand(button, fullContent) {
            const paragraph = button.parentElement.querySelector('p');
            
            if (button.textContent === 'å±•å¼€') {
                paragraph.textContent = fullContent;
                button.textContent = 'æ”¶èµ·';
            } else {
                const shortContent = fullContent.length > 150 ? fullContent.substring(0, 150) + '...' : fullContent;
                paragraph.textContent = shortContent;
                button.textContent = 'å±•å¼€';
            }
        }

        // åŠ è½½ä¼šè¯æ•°æ®
        function loadSessionData(sessionFile) {
            if (sessionFile === 'mock') {
                // åŠ è½½æ¨¡æ‹Ÿæ•°æ®ç”¨äºæ¼”ç¤º
                loadMockData();
                return;
            }
            
            // ä»æœåŠ¡å™¨è·å–çœŸå®çš„JSONä¼šè¯æ•°æ®
            fetch(`/api/session/${sessionFile}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(sessionData => {
                    // è§£æçœŸå®çš„JSONæ•°æ®ç»“æ„
                    const agents = sessionData.agents || [];
                    
                    // è¿‡æ»¤å‡ºå·²å®Œæˆçš„æ™ºèƒ½ä½“
                    const completedAgents = agents.filter(agent => 
                        agent.status === 'completed' && agent.result && agent.result.trim() !== ''
                    );
                    
                    if (completedAgents.length === 0) {
                        console.warn('æ²¡æœ‰æ‰¾åˆ°å·²å®Œæˆçš„æ™ºèƒ½ä½“æ•°æ®');
                        loadMockData();
                        return;
                    }
                    
                    // æ›´æ–°é¡µé¢æ˜¾ç¤º
                    updateVoteResults(completedAgents);
                    generateAnalysisCards(completedAgents);
                    generateTimeline(completedAgents);
                    
                    console.log(`æˆåŠŸåŠ è½½ä¼šè¯æ•°æ®: ${completedAgents.length} ä¸ªæ™ºèƒ½ä½“`);
                })
                .catch(error => {
                    console.error('åŠ è½½ä¼šè¯æ•°æ®å¤±è´¥:', error);
                    // å¦‚æœåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å¹¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    alert(`åŠ è½½ä¼šè¯æ•°æ®å¤±è´¥: ${error.message}\nå°†æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®`);
                    loadMockData();
                });
        }
        
        // åŠ è½½æ¨¡æ‹Ÿæ•°æ®
        function loadMockData() {
            const mockAgents = [
                {
                    agent_name: 'company_overview_analyst',
                    status: 'completed',
                    result: 'é™•è¥¿ç…¤ä¸šè‚¡ä»½æœ‰é™å…¬å¸æ˜¯ä¸­å›½é¢†å…ˆçš„ç…¤ç‚­å¼€é‡‡ä¼ä¸šï¼Œä¸»è¥ä¸šåŠ¡åŒ…æ‹¬ç…¤ç‚­å¼€é‡‡ã€æ´—é€‰ã€é”€å”®ç­‰ã€‚å…¬å¸æ‹¥æœ‰ä¸°å¯Œçš„ç…¤ç‚­èµ„æºå‚¨å¤‡ï¼Œåœ¨è¡Œä¸šä¸­å…·æœ‰é‡è¦åœ°ä½ã€‚'
                },
                {
                    agent_name: 'market_analyst',
                    status: 'completed',
                    result: 'ä»å¸‚åœºè¡¨ç°æ¥çœ‹ï¼Œå…¬å¸è‚¡ä»·è¿‘æœŸå‘ˆç°éœ‡è¡ä¸Šè¡Œè¶‹åŠ¿ï¼Œæˆäº¤é‡æ”¾å¤§ï¼Œå¸‚åœºå…³æ³¨åº¦è¾ƒé«˜ã€‚æŠ€æœ¯æŒ‡æ ‡æ˜¾ç¤ºå¤šå¤´åŠ›é‡å¢å¼ºã€‚'
                },
                {
                    agent_name: 'bull_researcher',
                    status: 'completed',
                    result: 'çœ‹æ¶¨è§‚ç‚¹ï¼šç…¤ç‚­ä»·æ ¼å›å‡ï¼Œå…¬å¸æˆæœ¬æ§åˆ¶è‰¯å¥½ï¼Œç›ˆåˆ©èƒ½åŠ›å¢å¼ºã€‚å»ºè®®ä¹°å…¥æŒæœ‰ã€‚'
                },
                {
                    agent_name: 'bear_researcher',
                    status: 'completed',
                    result: 'çœ‹è·Œè§‚ç‚¹ï¼šç¯ä¿æ”¿ç­–è¶‹ä¸¥ï¼Œç…¤ç‚­è¡Œä¸šé¢ä¸´è½¬å‹å‹åŠ›ï¼Œé•¿æœŸå‰æ™¯å­˜åœ¨ä¸ç¡®å®šæ€§ã€‚'
                },
                {
                    agent_name: 'risk_manager',
                    status: 'completed',
                    result: 'é£é™©è¯„ä¼°ï¼šæ”¿ç­–é£é™©ä¸­ç­‰ï¼Œå¸‚åœºé£é™©è¾ƒä½ï¼Œè´¢åŠ¡é£é™©å¯æ§ã€‚æ•´ä½“é£é™©ç­‰çº§ä¸ºä¸­ç­‰ã€‚'
                }
            ];
            
            updateVoteResults(mockAgents);
            generateAnalysisCards(mockAgents);
            generateTimeline(mockAgents);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSessions();
            
            // ä¼šè¯é€‰æ‹©äº‹ä»¶
            document.getElementById('sessionSelector').addEventListener('change', function() {
                if (this.value) {
                    loadSessionData(this.value);
                }
            });
            
            // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªä¼šè¯çš„æ¨¡æ‹Ÿæ•°æ®
            setTimeout(() => {
                loadSessionData('mock');
            }, 500);
        });
    </script>
</body>
</html>
