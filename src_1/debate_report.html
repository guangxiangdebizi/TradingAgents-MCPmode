<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ä½“ååŒåˆ†ææŠ¥å‘Š</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="top-nav">
        <div class="nav-container">
            <div class="nav-left">
                <span class="nav-icon">ğŸ”¬</span>
                <span class="nav-title">äººå·¥æ™ºèƒ½å®éªŒå®¤</span>
            </div>
            <div class="nav-right">
                <select id="sessionSelector" class="session-selector">
                    <option value="">é€‰æ‹©åˆ†æä¼šè¯...</option>
                </select>
                <button id="refreshBtn" class="nav-btn">åˆ·æ–°</button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- æŠ¥å‘Šæ ‡é¢˜åŒº -->
        <div class="title-section">
            <h1 class="main-title">æ™ºèƒ½ä½“ååŒåˆ†ææŠ¥å‘Š</h1>
            <p class="subtitle">äººå·¥æ™ºèƒ½å®éªŒå®¤æ™ºèƒ½åˆ†æAgentååŒåˆ†æ</p>
        </div>

        <!-- ä¸“å®¶æŠ•ç¥¨ç»“æœå¡ç‰‡ -->
        <div class="vote-card" id="voteCard" style="display: none;">
            <div class="vote-header">
                <h3>ğŸ“Š ä¸“å®¶æŠ•ç¥¨ç»“æœ</h3>
            </div>
            <div class="vote-content">
                <div class="vote-stats">
                    <div class="bullish">
                        <span class="vote-number" id="bullCount">0</span>
                        <span class="vote-label">çœ‹æ¶¨ Bullish</span>
                    </div>
                    <div class="bearish">
                        <span class="vote-number" id="bearCount">0</span>
                        <span class="vote-label">çœ‹è·Œ Bearish</span>
                    </div>
                </div>
                <div class="vote-bar">
                    <div class="bar-bullish" id="bullBar" style="width: 0%">0%</div>
                    <div class="bar-bearish" id="bearBar" style="width: 0%">0%</div>
                </div>
            </div>
        </div>

        <!-- ä¸“å®¶åˆ†æè¯¦æƒ… -->
        <div class="analysis-section" id="analysisSection" style="display: none;">
            <h2 class="section-title">ğŸ“‹ ä¸“å®¶åˆ†æè¯¦æƒ…</h2>
            <div class="analysis-grid" id="analysisGrid">
                <!-- åŠ¨æ€ç”Ÿæˆåˆ†æå¡ç‰‡ -->
            </div>
        </div>

        <!-- ä¸“å®¶è¾©è®ºè¿‡ç¨‹ -->
        <div class="debate-section" id="debateSection" style="display: none;">
            <h2 class="section-title">ğŸ—£ï¸ ä¸“å®¶è¾©è®ºè¿‡ç¨‹</h2>
            <p class="section-subtitle">AIæ™ºèƒ½ä½“ååŒåˆ†æè¿‡ç¨‹å®æ—¶è®°å½•</p>
            <div class="timeline" id="timeline">
                <!-- åŠ¨æ€ç”Ÿæˆæ—¶é—´è½´é¡¹ç›® -->
            </div>
        </div>

        <!-- å…è´£å£°æ˜ -->
        <div class="disclaimer" id="disclaimer" style="display: none;">
            <h3>âš ï¸ å…è´£å£°æ˜</h3>
            <p>æœ¬æŠ¥å‘Šç”±äººå·¥æ™ºèƒ½ç³»ç»Ÿç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ã€‚</p>
        </div>
    </div>

    <script>
        // æ™ºèƒ½ä½“ä¿¡æ¯æ˜ å°„
        const agentMapping = {
            'company_overview_analyst': { name: 'å…¬å¸æ¦‚è¿°åˆ†æå¸ˆ', emoji: 'ğŸ¢', type: 'analyst' },
            'market_analyst': { name: 'å¸‚åœºåˆ†æå¸ˆ', emoji: 'ğŸ“ˆ', type: 'analyst' },
            'sentiment_analyst': { name: 'æƒ…ç»ªåˆ†æå¸ˆ', emoji: 'ğŸ˜Š', type: 'analyst' },
            'news_analyst': { name: 'æ–°é—»åˆ†æå¸ˆ', emoji: 'ğŸ“°', type: 'analyst' },
            'fundamentals_analyst': { name: 'åŸºæœ¬é¢åˆ†æå¸ˆ', emoji: 'ğŸ“‹', type: 'analyst' },
            'shareholder_analyst': { name: 'è‚¡ä¸œåˆ†æå¸ˆ', emoji: 'ğŸ‘¥', type: 'analyst' },
            'product_analyst': { name: 'äº§å“åˆ†æå¸ˆ', emoji: 'ğŸ­', type: 'analyst' },
            'bull_researcher': { name: 'çœ‹æ¶¨ç ”ç©¶å‘˜', emoji: 'ğŸ‚', type: 'bull' },
            'bear_researcher': { name: 'çœ‹è·Œç ”ç©¶å‘˜', emoji: 'ğŸ»', type: 'bear' },
            'research_manager': { name: 'ç ”ç©¶ç»ç†', emoji: 'ğŸ‘”', type: 'manager' },
            'trader': { name: 'äº¤æ˜“å‘˜', emoji: 'ğŸ’¼', type: 'manager' },
            'aggressive_risk_analyst': { name: 'æ¿€è¿›é£é™©åˆ†æå¸ˆ', emoji: 'âš¡', type: 'risk' },
            'safe_risk_analyst': { name: 'ä¿å®ˆé£é™©åˆ†æå¸ˆ', emoji: 'ğŸ›¡ï¸', type: 'risk' },
            'neutral_risk_analyst': { name: 'ä¸­æ€§é£é™©åˆ†æå¸ˆ', emoji: 'âš–ï¸', type: 'risk' },
            'risk_manager': { name: 'é£é™©ç»ç†', emoji: 'ğŸ¯', type: 'risk' }
        };

        // è·å–æ™ºèƒ½ä½“ä¿¡æ¯
        function getAgentInfo(agentName) {
            return agentMapping[agentName] || { name: agentName, emoji: 'ğŸ¤–', type: 'other' };
        }

        // ç»Ÿè®¡æŠ•ç¥¨ç»“æœ
        function calculateVoteStats(agents) {
            let bullCount = 0;
            let bearCount = 0;
            
            agents.forEach(agent => {
                const agentName = agent.agent_name || '';
                const result = (agent.result || '').toLowerCase();
                
                if (agentName.includes('bull') || result.includes('çœ‹æ¶¨') || result.includes('ä¹°å…¥') || result.includes('ä¸Šæ¶¨')) {
                    bullCount++;
                } else if (agentName.includes('bear') || result.includes('çœ‹è·Œ') || result.includes('å–å‡º') || result.includes('ä¸‹è·Œ')) {
                    bearCount++;
                }
            });
            
            return { bull: bullCount, bear: bearCount };
        }

        // æ›´æ–°æŠ•ç¥¨ç»“æœ
        function updateVoteResults(agents) {
            const stats = calculateVoteStats(agents);
            const total = stats.bull + stats.bear;
            
            if (total === 0) return;
            
            const bullPercentage = (stats.bull / total) * 100;
            const bearPercentage = (stats.bear / total) * 100;
            
            document.getElementById('bullCount').textContent = stats.bull;
            document.getElementById('bearCount').textContent = stats.bear;
            document.getElementById('bullBar').style.width = bullPercentage + '%';
            document.getElementById('bullBar').textContent = bullPercentage.toFixed(1) + '%';
            document.getElementById('bearBar').style.width = bearPercentage + '%';
            document.getElementById('bearBar').textContent = bearPercentage.toFixed(1) + '%';
            
            document.getElementById('voteCard').style.display = 'block';
        }

        // ç”Ÿæˆåˆ†æè¯¦æƒ…å¡ç‰‡
        function generateAnalysisCards(agents) {
            const grid = document.getElementById('analysisGrid');
            grid.innerHTML = '';
            
            agents.forEach((agent, index) => {
                const agentInfo = getAgentInfo(agent.agent_name);
                const content = agent.result || '';
                
                // é™åˆ¶å†…å®¹é•¿åº¦
                const shortContent = content.length > 200 ? content.substring(0, 200) + '...' : content;
                
                const card = document.createElement('div');
                card.className = 'analysis-card';
                card.style.animationDelay = (index * 0.1) + 's';
                
                card.innerHTML = `
                    <div class="card-header">
                        <span class="agent-name">${agentInfo.emoji} ${agentInfo.name}</span>
                        <span class="agent-type ${agentInfo.type}">${agentInfo.type.toUpperCase()}</span>
                    </div>
                    <div class="card-content">
                        <p>${shortContent}</p>
                        ${content.length > 200 ? `<button class="expand-btn" onclick="toggleExpand(this, '${content.replace(/'/g, "\\'")}')">å±•å¼€è¯¦æƒ…</button>` : ''}
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            document.getElementById('analysisSection').style.display = 'block';
        }

        // ç”Ÿæˆæ—¶é—´è½´
        function generateTimeline(agents) {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            
            agents.forEach((agent, index) => {
                const agentInfo = getAgentInfo(agent.agent_name);
                const content = agent.result || '';
                const side = index % 2 === 0 ? 'left' : 'right';
                
                // é™åˆ¶å†…å®¹é•¿åº¦
                const shortContent = content.length > 300 ? content.substring(0, 300) + '...' : content;
                
                const item = document.createElement('div');
                item.className = `timeline-item ${side}`;
                item.style.animationDelay = (index * 0.1) + 's';
                
                item.innerHTML = `
                    <div class="timeline-card">
                        <div class="card-header">
                            <span class="agent-name">${agentInfo.emoji} ${agentInfo.name}</span>
                        </div>
                        <div class="card-content">
                            <p>${shortContent}</p>
                            <div class="timestamp">${new Date().toLocaleString('zh-CN')}</div>
                        </div>
                    </div>
                `;
                
                timeline.appendChild(item);
            });
            
            document.getElementById('debateSection').style.display = 'block';
        }

        // å±•å¼€/æ”¶èµ·è¯¦æƒ…
        function toggleExpand(button, fullContent) {
            const cardContent = button.parentElement;
            const paragraph = cardContent.querySelector('p');
            
            if (button.textContent === 'å±•å¼€è¯¦æƒ…') {
                paragraph.textContent = fullContent;
                button.textContent = 'æ”¶èµ·è¯¦æƒ…';
            } else {
                const shortContent = fullContent.length > 200 ? fullContent.substring(0, 200) + '...' : fullContent;
                paragraph.textContent = shortContent;
                button.textContent = 'å±•å¼€è¯¦æƒ…';
            }
        }

        // åŠ è½½ä¼šè¯æ•°æ®
        async function loadSessionData(sessionFile) {
            try {
                const response = await fetch(`/api/session/${sessionFile}`);
                const data = await response.json();
                
                if (data.agents) {
                    const completedAgents = data.agents.filter(agent => 
                        agent.status === 'completed' && agent.result
                    );
                    
                    if (completedAgents.length > 0) {
                        updateVoteResults(completedAgents);
                        generateAnalysisCards(completedAgents);
                        generateTimeline(completedAgents);
                        document.getElementById('disclaimer').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½ä¼šè¯åˆ—è¡¨
        async function loadSessionList() {
            try {
                const response = await fetch('/api/sessions');
                const sessions = await response.json();
                
                const selector = document.getElementById('sessionSelector');
                selector.innerHTML = '<option value="">é€‰æ‹©åˆ†æä¼šè¯...</option>';
                
                sessions.forEach(session => {
                    const option = document.createElement('option');
                    option.value = session.file;
                    option.textContent = `${session.name} (${session.time})`;
                    selector.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSessionList();
            
            // ä¼šè¯é€‰æ‹©äº‹ä»¶
            document.getElementById('sessionSelector').addEventListener('change', function() {
                if (this.value) {
                    loadSessionData(this.value);
                }
            });
            
            // åˆ·æ–°æŒ‰é’®äº‹ä»¶
            document.getElementById('refreshBtn').addEventListener('click', function() {
                loadSessionList();
            });
        });
    </script>
</body>
</html>
